<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700;900&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,900;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>
  <script
    src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin="">
  </script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
  <link rel="stylesheet" type="stylesheets/css" href="main.css">
  </head>


  <body>
    <div class="container-fluid">
    	<div class="row">
    		<div class="col-md-12 navigation">
    			<div id="logo">
    				<center>BIRDING THE BAY TRAIL</center>
    			</div>
    		</div>
    	</div>
    	<div class="row">
    		<div class="col-md-2">
          <div class="row">
            <h5>Nearby Locations</h5>
          </div>
          <div class="row">
            <%= link_to 'Show All Locations', locations_path%>
          </div>
          <div class="row">
            <div class = "sidenav">
              <% @locations_full.each do |location| %> 
                <div id="location-card" class="card">
                  <div class="card-body">
                    <h5 id="location-name"><%= location.name %></h5>
                    <p class="card-text" style="font-size: 14px;"><%= location.description %></p>
                  </div>
                </div>
                <br>
                <%= content_tag :div, class: "j-location_info", data: {loc: location} do %><% end %>
              <% end %>
            </div>
          </div>
    		</div>

    		<div class="col-md-8">
    			map
           <div id="mapid" style="height:500px"></div>
           <br><br><br><br><br><br><br><br>
          <form>
              <legend> Form for Dev only 2 decimal points</legend>
              <label for="lat">Latitude</label>
              <br>
              <input type="text" id="lat" name="lat" value=37.78>
              <br>
              <label for="lng">Longitude</label>
              <br>
              <input type="text" class id="lng" name="lng" value=-122.28>
              <br>
              <br>
              <button type="button" onClick="createPos(this.form)" class="btn btn-primary">Submit</button>
          </form>
	    	</div>

	        <div class="col-md-2">

                   <div id="js-com_bird_info" class="card">
                  </div>


	    	</div>
    	</div>

    </div>







    <script>
      $( document ).ready(getLocation)
      $(document ).ready(function(){
        $( ".j-location_info" ).each(function() {
          setLoc($(this).data('loc'));
        });

      });
      var greenIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      var blueIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
      var yellowIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      var bird_data = null;
      var bird_images = null;
      var mymap = L.map('mapid').setView([37.42, -121.91], 13);
      L.tileLayer('https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey={apikey}', {
          attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          apikey: 'df20324a5586441197c9410773b4ce60',
          maxZoom: 22
       }).addTo(mymap);

      function setContent(birddata,imgsrc,elem){
        $(elem).empty();
        $(elem).append(
          `
          <img class="card-img-top" src="${imgsrc}">
          <div class="card-body">
            <h5 class="card-title">${birddata.comName}</h5>
            <h6 class="card-subtitle mb-2 text-muted">${birddata.sciName}</h6>
            <p class="card-text">${birddata.distTo} miles away, at ${birddata.locName}</p>
            <p class="card-text">reported ${ moment(birddata.obsDt).fromNow()  }</p>
          </div>
          <a href="https://ebird.org/species/${birddata.speciesCode}" class="btn btn-primary">View On Ebird</a>
          `
        );
      }

      function setMarker(birddata, index){
        marker = new L.Marker(
          L.latLng(birddata.lat, birddata.lng),
          {name: `bird_marker_${index}`, icon: blueIcon}
        );
        mymap.addLayer(marker);
        marker.bindPopup(`<b>${birddata.comName}</b><br />${birddata.sciName}.`).openPopup();
        marker.on('click', markerOnClick);
        return marker
      }

      function setLoc(loc_data){
        marker = new L.Marker(
          L.latLng(loc_data.latitude, loc_data.longitude),
          {icon: yellowIcon}
        );
        mymap.addLayer(marker);
        marker.bindPopup(`<b>${loc_data.name}</b><br/>${loc_data.description}.`).openPopup();
        //marker.on('click', markerOnClick);
        return marker
      }

      function getLocation(){
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(parallelHitEbirdEndpoint);
        } else {
          console.log("no Location");
        }
      }
      function markerOnClick(e){
        i = this.options.name.slice(-1);
        setContent(bird_data[i],bird_images[i],$("#js-com_bird_info"));
      }

      function createPos(form){
        pos = {'coords':{'latitude':parseFloat(form.lat.value),'longitude':parseFloat(form.lng.value)}}
        parallelHitEbirdEndpoint(pos)
      }

      async function parallelHitEbirdEndpoint(pos){
        cur_pos = new L.LatLng(pos.coords.latitude, pos.coords.longitude)
        mymap.panTo(cur_pos);

        marker = new L.Marker(cur_pos,{icon: greenIcon});
        mymap.addLayer(marker);
        marker.bindPopup(`<b>You are here</b>`).openPopup();


        hitEbirdEndpoint(pos, false);
        //hitEbirdEndpoint(pos, true);

      }
      function hitEbirdEndpoint(pos, rare=false){
        var settings = {"url": "/ebird",
                        "method": "POST",
                        "timeout": 0,
                        "data":{
                            "authenticity_token" : "<%= form_authenticity_token %>",
                            "lat": pos.coords.latitude,
                            "lng": pos.coords.longitude,
                            "rare":rare,
                            "num_req":100,
                            "num_ret":10
                            }
                        }
        $.ajax(settings).done(function (response) {
          console.log(response);
          if(rare){
            setContent(response,$("#js-rare_bird_info"));
          }else{
            markers = []
            bird_data = response.birddata;
            bird_images = response.imgsrc;
            var arrayLength = bird_data.length;
            for (var i = 0; i < arrayLength; i++) {
              setContent(bird_data[i],bird_images[i],$("#js-com_bird_info"));
              markers.push(setMarker(bird_data[i],i))
            }
            var group = new L.featureGroup(markers);
            mymap.fitBounds(group.getBounds().pad(0.2));
          }

        });
      }

    </script>
  </body>
</html>
